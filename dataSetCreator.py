import os

def extractImports(sample, filepath):
	currentCorpus = []
	executablePath = filepath + '/' + sample
	try:
		executable = pefile.PE(executablePath)
		for IMAGE_IMPORT_DESCRIPTOR in executable.DIRECTORY_ENTRY_IMPORT:
			for function in IMAGE_IMPORT_DESCRIPTOR.imports:
				try:
					currentCorpus.append(function.name.decode())
				except:
					continue
	except (AttributeError, pefile.PEFormatError):
		return None
	return currentCorpus

def addSampleToDataSet(imports, Status, dataset):
	GetVersion = 0
	GetLocaleInfoA = 0
	LoadStringA = 0
	LoadStringW = 0
	DeleteProcThreadAttributeList = 0
	UpdateProcThreadAttribute = 0
	InitializeProcThreadAttributeList = 0
	LockSetForegroundWindow = 0
	SwitchToThisWindow = 0
	wcstol = 0
	wcscspn = 0
	CryptProtectData = 0
	lstrcmpi = 0
	VirtualFree = 0
	GetThreadLocale = 0
	GetLocaleInfoW = 0
	GetCommandLineW = 0
	CharNextA = 0
	RegQueryValueExA = 0
	RegOpenKeyExA = 0
	MulDiv = 0

	for function in imports:
		if function == 'GetVersion':
			GetVersion = 1
		elif function == 'GetLocaleInfoA':
			GetLocaleInfoA = 1
		elif function == 'LoadStringA':
			LoadStringA = 1
		elif function == 'LoadStringW':
			LoadStringW = 1
		elif function == 'DeleteProcThreadAttributeList':
			DeleteProcThreadAttributeList = 1
		elif function == 'UpdateProcThreadAttribute':
			UpdateProcThreadAttribute = 1
		elif function == 'InitializeProcThreadAttributeList':
			InitializeProcThreadAttributeList = 1
		elif function == 'LockSetForegroundWindow':
			LockSetForegroundWindow = 1
		elif function == 'SwitchToThisWindow':
			SwitchToThisWindow = 1
		elif function == 'wcstol':
			wcstol = 1
		elif function == 'wcscspn':
			wcscspn = 1
		elif function == 'CryptProtectData':
			CryptProtectData = 1
		elif function == 'lstrcmpi':
			lstrcmpi = 1
		elif function == 'VirtualFree':
			VirtualFree = 1
		elif function == 'GetThreadLocale':
			GetThreadLocale = 1
		elif function == 'GetCommandLineW':
			GetCommandLineW = 1
		elif function == 'GetLocaleInfoW':
			GetLocaleInfoW = 1
		elif function == 'CharNextA':
			CharNextA = 1
		elif function == 'RegQueryValueExA':
			RegQueryValueExA = 1
		elif function == 'RegOpenKeyExA':
			RegOpenKeyExA = 1
		elif function == 'MulDiv':
			MulDiv = 1

	dataset.write(
			f"{GetVersion},{GetLocaleInfoA},"
			f"{LoadStringA},{LoadStringW},"
			f"{DeleteProcThreadAttributeList},"
			f"{UpdateProcThreadAttribute},"
			f"{InitializeProcThreadAttributeList},"
			f"{LockSetForegroundWindow},{SwitchToThisWindow},"
			f"{wcstol},{wcscspn},{CryptProtectData},{lstrcmpi},"
			f"{VirtualFree},{GetThreadLocale},{GetLocaleInfoW},"
			f"{GetCommandLineW},{CharNextA},"
			f"{RegQueryValueExA},{RegOpenKeyExA},{MulDiv},"
			f"{Status}")


def main():
	malware_path = '/home/student/Downloads/Malware'
	benign_path = '/home/student/Downloads/Benign'
	with open('dataset.csv', 'a') as dataset:
		dataset.write(
			"GetVersion,GetLocaleInfoA,"
			"LoadStringA,LoadStringW,"
			"DeleteProcThreadAttributeList,"
			"UpdateProcThreadAttribute,"
			"InitializeProcThreadAttributeList,"
			"LockSetForegroundWindow,SwitchToThisWindow,"
			"wcstol,wcscspn,CryptProtectData,lstrcmpi,"
			"VirtualFree,GetThreadLocale,GetLocaleInfoW,"
			"GetCommandLineW,CharNextA,"
			"RegQueryValueExA,RegOpenKeyExA,MulDiv,Status\n"
		)
		malware_samples = os.listdir(malware_path)
		benign_samples = os.listdir(benign_path)
		for malware in malware_samples:
			imports = extractImports(malware, malware_path)
			if imports is not None:
				addSampleToDataSet(imports, 0, dataset)
		print('[+] Completed Malware Samples')
		for benign_executable in benign_samples:
			imports = extractImports(benign_executable, benign_path)
			if imports is not None:
				addSampleToDataSet(imports, 1, dataset)
		print('[+] Completed Benign Samples')		

if __name__ == '__main__':
	main()
