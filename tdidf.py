import pefile
import os 


filepath = '/home/student/Downloads/Malware'

totalCorpus = []

def extractImports(sample):
	global filepath
	global totalCorpus
	currentCorpus = []
	executablePath = filepath + '/' + sample
	try:
		executable = pefile.PE(executablePath)
		for IMAGE_IMPORT_DESCRIPTOR in executable.DIRECTORY_ENTRY_IMPORT:
			for function in IMAGE_IMPORT_DESCRIPTOR.imports:
				try:
					currentCorpus.append(function.name.decode())
					totalCorpus.append(function.name.decode())
				except:
					continue
	except (AttributeError, pefile.PEFormatError):
		return None
	return currentCorpus

def main():
	global filepath
	global totalCorpus
	samples = os.listdir(filepath)
	IDFs = {}
	for sample in samples:
		currentCorpus = extractImports(sample)
		if currentCorpus is not None:
			for apiCall in currentCorpus:
				if apiCall in IDFs:
					continue	
				else:
					count = 0
					for call in totalCorpus:
						if apiCall == call:
							count += 1
					IDFs[apiCall] = count
	
	
	sortedAPICalls = sorted(IDFs.items(), key=lambda x:x[1])
	rankedAPICalls = dict(sortedAPICalls)
	for entry in rankedAPICalls:
		print(f'The function: {entry} has been used {rankedAPICalls[entry]} times!')

if __name__ == '__main__':
	main()
